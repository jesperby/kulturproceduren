<%= render :partial => "events/menu" -%>

<% if user_online? && current_user.can_administrate?(@event.culture_provider) -%>
  <div class="admin-tools">
    <h4>Administrera <%= h @event.name %></h4>
    <ul>
      <li><%= link_to 'Redigera', edit_event_path(@event) %></li>

      <% unless @event.bookable? %>
        <li>
          <%= link_to 'Radera', event_path(@event), :method => :delete, :confirm => "Är du säker på att du vill radera evenemanget?" %>
        </li>
      <% end %>

      <li><%= link_to 'Hantera bilder', event_images_path(@event) %></li>
      <li><%= link_to 'Hantera filer', event_attachments_path(@event) %></li>
      <li><%= link_to 'Hantera länkade evenemang', handle_links_event_path(@event) %></li>

      <% if current_user.has_role?(:admin) && (@event.ticket_release_date.nil? || @event.ticket_release_date > Date.today) -%>
        <li><%= link_to 'Fördela inköpta biljetter', :controller => "allotment", :action => "init", :id => @event.id %></li>
      <% end -%>

      <% if current_user.has_role?(:admin) -%>
        <li><%= link_to "Statistik", stats_event_path(@event) %></li>
      <% end -%>
    </ul>
  </div>
<% end -%>

<div id="kp-sec-content" class="event-sec-content">
  <%= render :partial => "culture_providers/info_box", :locals => { :culture_provider => @event.culture_provider } -%>
</div>

<div id="kp-pri-content" class="event-pri-content">

  <div class="model-cnt">

    <% if !@event.images_excluding_main.empty? %>
      <div class="images-cnt">
        <div class="images">
          <% @event.images_excluding_main.each do |image| -%>
            <%= image_tag image.image_url, :alt => image.name, :width => image.width, :height => image.height %>
          <% end -%>
        </div>
      </div>
    <% end -%>

    <h2><%= h @event.name %></h2>
    <%= paragraphize(@event.description, 'class="description"') %>

    <% if user_online? && current_user.can_administrate?(@event.culture_provider) -%>
      <%= render :partial => "occasions/form", :locals => { :event => @event } %>
    <% end -%>
  </div>
</div>


<div class="tabs">
  <ul>
    <li><a href="#kp-ev-meta-info">Information</a></li>
    <% unless @event.occasions.empty? -%>
      <li class="<%= "preselect" if @selected_occasion %>"><a href="#kp-ev-meta-occasions">Datum och tider</a></li>
    <% end -%>
  </ul>

  <div id="kp-ev-meta-info">
    <table class="meta">
      <% if user_online? && current_user.can_administrate?(@event.culture_provider) %>
        <tr class="show-date">
          <th>Visas mellan</th>
          <td><%= h @event.visible_from %> och <%= h @event.visible_to %></td>
        </tr>
        <% unless @event.ticket_release_date.blank? -%>
          <tr class="ticket-release-date">
            <th>Biljettsläpp</th>
            <td><%= h @event.ticket_release_date %></td>
          </tr>
        <% end -%>
      <% end -%>
      <% unless @event.booking_info.blank? -%>
        <tr class="booking-info">
          <th>Bokningsinformation</th>
          <td><%= auto_link h(@event.booking_info) %></td>
        </tr>
      <% end -%>
      <% unless @event.cost.blank? -%>
        <tr class="cost">
          <th>Kostnad</th>
          <td><%= linebreakize(@event.cost) %></td>
        </tr>
      <% end -%>
      <tr class="culture-provider">
        <th>Arrangör</th>
        <td><%= link_to h(@event.culture_provider.name), culture_provider_path(@event.culture_provider) %></td>
      </tr>
      <% if @event.further_education -%>
        <tr class="further-education">
          <th>Fortbildning pedagoger/vuxna</th>
          <td>Ja</td>
        </tr>
      <% else %>
        <tr class="ages">
          <th>För åldrar</th>
          <td><%= @event.from_age %>-<%= @event.to_age %> år</td>
        </tr>
      <% end -%>

      <% @category_groups.each do |category_group| -%>
        <% category_names = @event.categories.select { |c| c.category_group_id == category_group.id }.map { |c| c.name } %>

        <% unless category_names.empty? -%>
          <tr class="categories">
            <th><%= h category_group.name %></th>
            <td>
              <%= h(category_names.join(", ")) %>
            </td>
          </tr>
        <% end -%>
      <% end -%>

      <% unless @event.opening_hours.blank? -%>
        <tr class="opening-hours">
          <th>Öppettider</th>
          <td><%= linebreakize(@event.opening_hours) %></td>
        </tr>
      <% end -%>
      <% unless @event.url.blank? -%>
        <tr class="url">
          <th>Extern länk</th>
          <td>
            <a href="<%= qualified_url(@event.url) %>"><%= h(@event.url) %></a>
          </td>
        </tr>
      <% end -%>
      <% unless @event.movie_url.blank? -%>
        <tr class="movie-url">
          <th>Youtube-länk</th>
          <td>
            <a href="<%= qualified_url(@event.movie_url) %>"><%= h(@event.movie_url) %></a>
          </td>
        </tr>
      <% end -%>

      <% if user_online? && !@event.attachments.empty? %>
        <tr class="attachments">
          <th>Bifogade filer</th>
          <td>
            <ul>
              <% @event.attachments.each do |attachment| -%>
                <li>
                  <%= link_to h(attachment.description), event_attachment_path(@event, attachment) %>
                </li>
              <% end %>
            </ul>
          </td>
        </tr>
      <% end %>

      <% if !@event.linked_events.empty? %>
        <tr class="linked-events">
          <th>Se även</th>
          <td>
            <ul>
              <% @event.linked_events.each do |event| -%>
                <li><%= link_to event.name, event %></li>
              <% end %>
            </ul>
          </td>
        </tr>
      <% end %>
    </table>
  </div>

  <% unless @event.occasions.empty? -%>
    <div id="kp-ev-meta-occasions">
      <table class="occasion-list">
        <thead>
          <tr>
            <th class="date-time">Datum/tid</th>
            <th class="num-seats">Lediga platser</th>
            <th class="address">Adress</th>
            <th class="description">Beskrivning</th>
            <th class="tools"></th>
          </tr>
        </thead>

        <tbody>
          <% @event.occasions.each do |occasion|
            alt = cycle('', "even") %>
            <tr class="<%= alt %> <%= "selected" if @selected_occasion && @selected_occasion.id == occasion.id %> <%= "cancelled" if occasion.cancelled %>">
              <td class="date-time">
                <span class="date"><%= h occasion.date %></span>
                <span class="time">
                  <%= l occasion.start_time, :format => :only_time %> - <%= l occasion.stop_time, :format => :only_time %>
                </span>
              </td>
              <td class="num-seats">
                <% available_seats = occasion.available_seats %>

                <%= h(available_seats) %>
                <%= image_tag "icon_rullstol.png", :alt => "Rullstolsplatser finns", :title => "Rullstolsplatser finns" if occasion.wheelchair_seats.to_i > 0 %>
              </td>
              <td class="address"><%= linebreakize(occasion.address) %></td>
              <td class="description"><%= linebreakize(occasion.description) %></td>
              <td class="tools">
                <% if occasion.cancelled %>
                  <span class="cancelled">Inställd</span>
                <% elsif user_online? -%>
                  <% if @event.bookable? && current_user.can_book? -%>

                    <% if available_seats > 0 %>
                      <%= link_to "Boka", new_occasion_booking_path(occasion), :title => "#{available_seats} lediga platser" %>
                    <% else %>
                      <span class="sold-out">Fullbokat</span>
                    <% end %>
                  <% end -%>

                  <% if current_user.can_administrate?(@event.culture_provider) -%>
                    <%= link_to "Redigera", edit_occasion_path(occasion) %>

                    <% if @event.bookable? %>
                      <% if occasion.date >= Date.today && !occasion.cancelled %>
                        <%= link_to "Ställ in",
                          cancel_occasion_path(occasion),
                          :method => "delete",
                          :confirm => "Är du säker på att du vill ställa in föreställningen?"
                        %>
                      <% end %>
                    <% else %>
                      <%= link_to "Ta bort", occasion,
                        :method => "delete",
                        :confirm => "Är du säker på att du vill radera föreställningen?"
                      %>
                    <% end %>
                  <% end -%>

                  <% if occasion.date > Date.today %>
                    <%= link_to "Närvarolista", attendants_occasion_path(occasion) %>
                  <% elsif !occasion.cancelled && (current_user.has_role?(:admin) || current_user.has_role?(:host)) %>
                    <%= link_to "Rapportera närvaro", report_show_occasion_path(occasion) -%>
                  <% end %>
                <% elsif @event.bookable? %>
                  <span>Logga in för att boka</span>
                <% end %>
              </td>
            </tr>
          <% end -%>
        </tbody>

      </table>
    </div>
  <% end -%>

</div>

