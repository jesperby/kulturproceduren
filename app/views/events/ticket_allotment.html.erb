<%# coding: utf-8 %>
<%= render :partial => "menu" -%>

<h2 class="form-title">
  Fördelning för <%= link_to @event.name, @event %>
</h2>

<div class="admin-tools">
  <ul>
    <% if current_user.has_role?(:admin) && !@event.further_education && (@event.ticket_release_date.nil? || @event.ticket_release_date > Date.today) -%>
      <li><%= link_to "Ändra fördelning", :controller => "allotment", :action => "init", :id => @event.id %></li>
    <% end -%>
    <li>
      <%= link_to "Ladda ner fördelningen som Excel-fil", ticket_allotment_event_path(@event, :format => :xls) %>
    </li>
  </ul>
</div>


<table id="kp-ticket-allotment-list">
  <thead>
    <tr>
      <th>Namn</th>
      <th>Antal biljetter</th>
    </tr>
  </thead>

  <tbody>
    <%
    prev_district_id = nil
    prev_school_id = nil
    %>
    <% @event.allotments.each do |allotment| %>
      <% if allotment.for_group? %>
        <% if allotment.district_id != prev_district_id %>
          <tr class="district-row">
            <td class="name"><%= allotment.district.name %></td>
            <td class="count"></td>
            <% prev_district_id = allotment.district_id %>
          </tr>
        <% end %>
        <% if allotment.group.school_id != prev_school_id %>
          <tr class="school-row">
            <td class="name"><%= allotment.group.school.name %></td>
            <td class="count"></td>
            <% prev_school_id = allotment.group.school_id %>
          </tr>
        <% end %>
      <% end %>
      <tr class="<%= allotment.for_group? ? "group" : "district" %>-row">
        <td class="name">
          <% if allotment.for_group? %>
            <%= allotment.group.name %>
          <% elsif allotment.for_district? %>
            <%= allotment.district.name %>
          <% else %>
            Hela staden
          <% end %>
        </td>
        <td class="count"><%= allotment.amount %></td>
      </tr>
    <% end %>
  </tbody>
</table>
