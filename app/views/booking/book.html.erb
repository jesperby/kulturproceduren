<%= render :partial => "menu" %>

<%

  state = :no_selection

  case params[:commit]
  when "Hämta skolor"
    state = :district_selected
  when "Hämta grupper"
    state = :school_selected
  when "Välj grupp"
    state = :group_selected
  end

%>

<h2 class="form-title">
  Boka biljetter för
  <%= link_to h(@occasion.event.name), @occasion.event -%>,
  föreställningen <%= h @occasion.date -%>
</h2>

<% if @occasion.event.ticket_state == Event::FREE_FOR_ALL %>
  <p class="message response">
    Det finns totalt
    <%= [
      Ticket.count(:conditions => { :event_id => @occasion.event.id , :state => Ticket::UNBOOKED } ),
      ( @occasion.seats - Ticket.count(:conditions => { :occasion_id => @occasion.id, :state => Ticket::BOOKED} ) )
    ].sort.first -%>
    biljetter tillgängliga för bokning.
  </p>
<% end %>

<div class="booking-group-selection">
  <%= render :partial => "shared/group_selection", :locals => { :occasion => @occasion } %>

  <div class="notification-request-info">
    <p>
      Hittar du inte din grupp?
    </p>
    <p>
      <%= link_to "Klicka här", new_occasion_notification_request_path(@occasion) %>
      för att få ett meddelande när biljetter blir tillgängliga.
    </p>
  </div>

</div>

<% form_tag({ :controller => "booking", :action => "book" }, { :class => "booking-form" }) do -%>
  <fieldset>

    <% if @errors.keys.length > 0 %>
      <div class="validation-error-indicator alert"> Vänligen korrigera markerade uppgifter nedan.</div>
    <% end %>

    <%= hidden_field_tag 'occasion_id' , @occasion.id %>

    <div id="kp-input-area">
      <% if session[:group_selection][:group_id] || @edit %>

        <%= render :partial => "input_area",
          :locals => {
          :group => @curgroup,
          :occasion => @occasion,
          :companion => @companion,
          :nticks => @nticks,
          :naticks => @naticks,
          :nwticks => @nwticks,
          :br => @br,
          :edit => @edit
        } %>

      <% end %>
    </div>

  </fieldset>
<% end %>

