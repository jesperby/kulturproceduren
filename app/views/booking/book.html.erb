<%= render :partial => "menu" %>

<%

  state = :no_selection

  case params[:commit]
  when "Hämta skolor"
    state = :district_selected
  when "Hämta grupper"
    state = :school_selected
  when "Välj grupp"
    state = :group_selected
  end

%>

<h3>
  Boka biljetter för
  <%= link_to h(@occasion.event.name), @occasion.event -%>,
  föreställningen <%= h @occasion.date -%>
</h3>

<% if @occasion.event.ticket_state == Event::FREE_FOR_ALL %>
  <p class="message notice">
    Det finns totalt
    <%= [
      Ticket.count(:conditions => { :event_id => @occasion.event.id , :state => Ticket::UNBOOKED } ),
      ( @occasion.seats - Ticket.count(:conditions => { :occasion_id => @occasion.id, :state => Ticket::BOOKED} ) )
    ].sort.first -%>
    biljetter tillgängliga för bokning.
  </p>
<%  end %>

<% form_tag({ :controller => "booking", :action => "book" }, { :class => "booking-form" }) do -%>

  <fieldset>
    <%= hidden_field_tag 'occasion_id' , @occasion.id %>

    <fieldset class="group-selector-container">

      <div class="form-row district_id-field-row">
        <%= label_tag "district_id" , "Välj Stadsdel:"%>

        <div class="input-container">
          <%
            opt_tag = "<option>Välj Stadsdel</option>"
            opt_tag += options_for_select(
              @districts.collect { |d|
              [d.name + ( @occasion.event.ticket_state == Event::ALLOTED_DISTRICT ? " (#{d.available_tickets_per_occasion(@occasion)} biljetter)" : "" ), d.id.to_s ]
            }, params[:district_id].to_s
            )
          %>

          <%= select_tag "district_id", opt_tag %>

          <% if state == :no_selection %>
            <noscript>
              <input name="commit" type="submit" value="Hämta skolor" />
            </noscript>
          <% end %>

        </div>
      </div>

      <div class="form-row school_id-field-row">
        <%= label_tag "school_id" , "Välj Skola:" %>

        <div class="input-container">
          <% if @schools.nil? %>
            <select id="kp-school_id" name="school_id" disabled="disabled">
              <option>Välj stadsdel först</option>
            </select>
          <% else %>
            <select id="kp-school_id" name="school_id">
              <%= options_for_select(@schools.collect { |s| [ s.name , s.id.to_s ]}, params[:school_id].to_s) %>
            </select>
          <% end %>

          <% if state == :district_selected %>
            <noscript>
              <input name="commit" type="submit" value="Hämta grupper" /><br/>
            </noscript>
          <% end %>
        </div>
      </div>

      <div class="form-row group_id-field-row">
        <%= label_tag "group_id" , "Välj Grupp:"%>

        <div class="input-container">
          <% if @groups.nil? %>

            <%  if @schools.nil?  %>
              <select id="kp-group_id" name="group_id" disabled="disabled"><option>Välj stadsdel först</option></select>
            <% else %>
              <select id="kp-group_id" name="group_id" disabled="disabled"><option>Välj skola först</option></select>
            <% end %>

          <% else %>

            <select id="kp-group_id" name="group_id" <%= @edit.blank? ? "" : 'disabled="disabled"' -%>>
              <option>Välj grupp</option>
              <% selected = @curgroup ? @curgroup.id : nil %>
              <%= options_for_select(
                @groups.map { |g|
                [ g.name + (@occasion.event.ticket_state == Event::ALLOTED_GROUP ? " (#{g.ntickets_by_occasion(@occasion)} biljetter)" : "") , g.id ]
              }, (@curgroup ? @curgroup.id : nil)
              ) %>
            </select>

          <% end %>

          <% if params[:commit] == "Hämta grupper" or params[:commit] == "Välj grupp" && @curgroup.blank? %>
            <noscript>
              <input name="commit" type="submit" value="Välj grupp" /><br/>
            </noscript>
          <% end %>
        </div>
      </div>
    </fieldset>

    <div id="kp-input-area">
      <%= render(:partial => "input_area" ,
                 :locals => {
        :group => @curgroup ,
        :occasion => @occasion ,
        :companion => @companion ,
        :nticks => @nticks ,
        :naticks => @naticks ,
        :nwticks => @nwticks ,
        :br => @br ,
        :edit => @edit
      }) if params[:commit] == "Välj grupp" %>
    </div>

  </fieldset>
<% end %>

