<%
hide_culture_provider ||= false
category_groups ||= []
num_category_groups = 0
-%>

<table class="calendar-list">
  <thead>
    <tr>
      <th class="time">Tid</th>
      <th class="event">Evenemang</th>

      <% unless hide_culture_provider -%>
        <th class="culture-provider">Arrangör</th>
      <% end %>

      <th class="age">Ålder</th>

      <% category_groups.each do |category_group| -%>
        <% if category_group.visible_in_calendar %>
          <th class="categories"><%= category_group.name %></th>
          <% num_category_groups += 1 %>
        <% end %>
      <% end -%>

      <th class="booking"><%= user_online? ? "Boka" : "Bokas via" %></th>
      <th class="icon-indicator">Hjälpmedel</th>
    </tr>
  </thead>

  <tbody>
    <% prev_date = Date.new %>

    <% occasions.each do |occasion| -%>

      <% if prev_date < occasion.date %>
        <tr class="date-row <%= cycle('', 'even')  %>">
          <th colspan="<%= (hide_culture_provider ? 5 : 6) + num_category_groups %>"><%= occasion.date %></th>
        </tr>
      <% end -%>

      <tr class="<%= cycle('', 'even')  %>">
        <td class="time"><%= l occasion.start_time, format: :only_time %></td>
        <td class="event"><%= link_to occasion.event.name, occasion.event %></td>

        <% unless hide_culture_provider -%>
          <td class="culture-provider"><%= link_to occasion.event.culture_provider.name, occasion.event.culture_provider %></td>
        <% end -%>

        <td class="age">
          <% if !occasion.event.further_education %>
            <%= occasion.event.from_age %>-<%= occasion.event.to_age %>
          <% end %>
        </td>

        <% category_groups.each do |category_group| -%>
          <% if category_group.visible_in_calendar %>
            <td class="categories">
              <%= occasion.event.categories.select { |c| c.category_group_id == category_group.id }.map { |c| c.name }.join(", ") %>
            </td>
          <% end %>
        <% end -%>

        <td class="booking">

          <% if user_online? && current_user.can_book?  %>
            <% if occasion.event.bookable? %>
              <% available_seats = [ occasion.available_seats.to_i, occasion.event.unbooked_tickets.to_i ].min %>

              <% if available_seats > 0 %>
                <%= link_to "Boka", new_occasion_booking_path(occasion), title: "#{available_seats} lediga platser" %>
              <% else %>
                <span class="sold-out">Fullbokat</span>
              <% end %>

              <a href="<%= ticket_availability_occasion_path(occasion) %>"
                 class="ticket-availability-link"
                 title="Platstillgänglighet för <%= occasion.event.name %> <%= occasion.date %> <%= l occasion.start_time, format: :only_time %>">
                <%= image_tag "information.png", alt: "Platstillgänglighet" %>
              </a>
            <% end %>
          <% else %>
            <% if occasion.event.bookable? %>
              <%= login_link "Kulturproceduren", new_occasion_booking_path(occasion) %>
            <% else %>
              <%= link_to "Arrangören", occasion.event %>
            <% end %>
          <% end %>
        </td>

        <td class="icon-indicator">
          <%= image_tag "icon_rullstol.png", alt: "Rullstolsplatser finns", title: "Rullstolsplatser finns" if occasion.wheelchair_seats.to_i > 0 %>
          <%= image_tag "icon_horslinga.png", alt: "Hörselslinga finns", title: "Hörselslinga finns" if occasion.telecoil %>
        </td>
      </tr>

      <% prev_date = occasion.date %>
    <% end -%>
  </tbody>
</table>
